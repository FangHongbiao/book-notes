# 第 3 章    文件

MySQL包含的文件: 参数文件、日志文件、socket文件、pid文件、MySQL表结构文件、存储引擎文件

1. 参数文件
   1. 通过命令`mysql --help | grep my.cnf`查看优先级
   2. MySQL启动可以不指定参数文件， 因为存在默认值。 但是如果MySQL实例在默认的数据库目录下找不到MySQL架构， 同样会启动失败
   3. 参数类型
      1. 动态参数： 可以在MYSQL实例中进行更改， 通过SET命令
      2. 静态参数： 在整个实例生命周期内都不得更改
   
2. 日志文件
   1. 类型
      1. 错误日志 (error log)
      2. 二进制日志 （binlog)
      3. 慢查询日志 （slow query log)
      4. 查询日志 （log)
   2. 错误日志
      1. 对MySQL的启动、运行、关闭过程进行了记录
      2. `SHOW VARIABLES LIKE 'log_error'`
   3. 慢查询日志
      1. 帮助DBA定位可能存在问题的SQL语句， 从而进行SQL语句层面的优化
      2. 阈值通过参数`long_query_time`来设置， 默认为10(s). 等于阈值的不会被记录
      3. MySQL默认不开启慢查询日志， 需要手动设置为ON
      4. 从MySQL5.1开始， `long_query_time`的单位是微秒
      5. 另一个与慢查询日志有关的参数`log_queries_not_using_indexes`， 如果运行的SQL语句没有使用索引， 则MySQL数据库同样将这条SQL语句记录到慢查询日志
      6. MySQL 5.6.5开始新增了一个参数`log_throttle_queries_not_using_indexes`来表示每分钟允许记录到  slow log的且未使用索引的SQL语句次数。 默认为0， 表示没有限制
      7. `mysqldumpslow`命令
   4. 查询日志
      1.  记录了所有对MySQL数据库请求的信息， 无论这些请求是否得到了执行。 默认文件名为：主机名.log
      2. MySQL 5.1开始， 可以将查询日志的记录放入mysql架构下的general_log表中
   5. 二进制日志
      1. 记录了对MySQL数据库执行更改的所有操作， 但是不包括SELECT和SHOW这类操作。若操作本身并没有数据库发生变化，该操作也可能会写入二进制日志
      2. 二进制日志的作用
         1. 恢复： 例如， 在一个数据全备文件恢复后， 用户可以通过二进制日志进行point-in-time的恢复
         2. 复制：通过复制和执行二进制日志使一台远程的MySQL数据库与一台MySQL数据库进行实时同步
         3. 审计： 用户可以通过二进制日志中的信息来进行审计， 判断是否有对数据库进行的注入攻击
      3. 通过配置参数`log-bin[=name]`可以启动二进制日志。 如果不指定name， 则默认二进制日志文件名为主机名， 后缀名为二进制日志的序列号， 所在路径为数据库所在目录。
      4. 影响二进制日志的参数
         1. max_binlog_size
         2. binlog_cache_size
         3. sync_binlog
         4. binlog-do-db
         5. binlog-ignore-db
         6. log-slave-update
         7. binlog_format
      5. 二进制文件需要使用MySQL提供的工具`mysqlbinlog`来查看
   
3. 套接字文件： Unix系统下本地连接MySQL可以采用Unix域套接字方式， 这种方式需要一个套接字文件。 套接字文件可由参数socket控制， 一般在`/tmp/mysql.sock`

4. pid 文件

   1. 当MySQL实例启动时， 会将自己的进程ID写入一个文件中， 即pid文件。 该文件可由参数`pid_file`控制， 默认位于数据库目录下， 文件名为 `主机名.pid`

5. 表结构定义文件

   1. MySQL数据存储是根据表进行的， 与存储引擎有关
   2. 统一的是， 都有一个以`frm`为后缀名的文件， 该文件定义了表结构
   3. `frm`还用来存放视图的定义
   4. 该文件是文本文件， 可以直接使用`cat`命令查看

6. InnoDB存储引擎文件

   1. 表空间文件

      1. 共享表空间
      2. 独立表空间
         1. 通过参数 `innodb_file_per_table=ON`设置
         2. 单独表空间文件仅存储该表的数据、索引和插入缓冲BITMAP等信息， 其与信息还是放在默认表空间中

   2. 重做日志文件

      1. Innodb存储引擎的数据目录下有两个名为`ib_logfile0`和`ib_logfile1`的文件

      2. 记录了对于Innodb存储引擎的事务日志

      3. 当实例或介质失败时， 重做日志就能派上用场

      4. 重做日志文件的大小对性能有很大影响

         1. 不能设置得太大： 如果设置得很大， 在恢复时可能需要很长时间
         2. 不能设置得太小： 
            1. 可能导致一个事务的日志需要多次切换重做日志文件
            2. 会导致频繁地发生 `async checkpoint`，导致西能抖动

      5. 重做日志文件和二进制日志的区别

         1. 二进制日志会记录所有与MySQL数据库有关的日志记录， 包括 Innodb、 MyISAM、Heap等其他存储引擎的日志。 而InnoDB的重做日志文件只记录有关该存储引擎本身的事务日志
         2. 记录的内容不同。无论用户将二进制日志文件记录的格式设置为 `STATEMENT`还是 `ROW`， 又或者是 `MIXED`， 其记录的都是关于一个事务的具体操作内容， 即该日志是逻辑日志。而InnoDB存储引擎的重做日志文件记录的是关于每个(Page)的更改的物理情况
         3. 写入时间不同。二进制日志文件仅在事务提交前进行提交， 即只写磁盘一次， 不论这时该事务多大。 而在事务进行的过程中，却不断有重做日志条目(entry)被写到重做日志文件中

      6. 重做日志条目的结构

         | redo_log_type | space | page_no | redo_log_body |
         | ------------- | ----- | ------- | ------------- |
         |               |       |         |               |

      7. 写入重做日志文件的操作不是直接写， 而是先写入一个重做日志缓冲， 然后按照**一定的条件**顺序地写入日志文件

         1. 主线程每秒会将重做日志缓冲写入磁盘日志文件中，不论事务是否已经提交
         2. 参数`innodb_flush_log_at_trx_commit`控制在提交操作时， 处理重做日志的方式，有效值为0,1,2
            1. 0： 表示当事务提交时， 不将事务的重做日志写入到磁盘上的日志文件， 而是等待主线程每秒的刷新
            2. 1：表示执行commit时， 将重做日志缓冲同步写到磁盘， 即伴有fsync的调用
            3. 2： 表示将重做日志异步写到磁盘， 即写到文件系统缓存中。因此不能完全保证在执行commit时肯定会写入重做日志文件，只是有这个动作发生

      8. 从重做日志缓冲往磁盘写入时， 是按512个字节，也就是一个扇区的大小进行写入。因为扇区是写入的最小单位， 因此可以保证写入必定是成功的。因此在重做日志写入过程中不需要有doublewrite

# 第 4 章    表

1. 索引组织表

   1. 在InnoDB存储引擎中， 表都是根据主键顺序组织存放的， 这种存储方式的表称为索引组织表
   2. 如果没有定义主键， 默认选择或创建策略
      1. 首先判断表中是否有非空唯一索引(Unique NOT NULL), 如果有， 则该列为主键。 如果存在多个， 选择第一个定义的非空唯一索引(是定义索引的顺序， 不是建表时列的顺序)
      2. 如果不符合上述条件， InnoDB存储引擎自动创建一个6字节大小的指针
   3. `_rowid`可以显示表的主键， 但是只能用于查看单个列为主键的情况， 对于多列组成的主键无能为力

2. InnoDB 逻辑存储结构

   从 InnoDB存储引擎的逻辑存储结构来看， 所有数据都被逻辑地放在一个空间中， 称之为表空间。表空间又由段(segment)、区(extent)、页(page)/块(block)组成.

   1. 表空间
      1. 共享表空间 ibdata1
      2. 独立表空间： 
         1. 由参数`innodb_file_per_table`控制
         2. 存放的知识数据、索引和插入缓冲Bitmap页， 其他数据，如回滚信息、插入缓冲页、系统事务信息、二次缓冲写等还是放在原来的共享表空间中
   2. 段
      1. 表空间由各个段组成， 常见的段有数据段、索引段、回滚段等
      2. InnoDB存储引擎是索引组织的， 因此数据即索引， 索引即数据。 数据段即为B+树的叶子节点， 索引段即为B+树的非叶子节点
   3. 区
      1. 区是由连续的页组成的空间， 在任何情况下每个区的大小都是1MB。 一个区中有64个连续的页(通常页大小16KB)
      2. 1.0.x 开始引入压缩页， 可以通过参数`KEY_BLOCK_SIZE`将页大小设置为2K、4K、8K， 则每个区对应的页数量就是512、256、128
      3. 1.2.x 新增参数`innodb_page_size`，可以将默认页大小设置为4k、8K， 但是页中数据不是压缩的。
   4. 页
      1. 也可以称之为“块”, 是InnoDB磁盘管理的最小单位。默认16KB
      2. 常见的页类型
         1. 数据页 (B-tree Node)
         2. undo 页 (undo Log Page)
         3. 系统页 (System Page)
         4. 事务数据页 (Transaction system Page)
         5. 插入缓冲位图页 (Insert Buffer Bitmap)
         6. 插入缓冲空闲列表页 (Insert Buffer Free List)
         7. 未压缩的二进制大对象页 (Uncompressed BLOB Page)
         8. 压缩的二进制大对象页 (compressed BLOB Page)
   5. 行
      1. InnoDB存储引擎是面向行的， 按行存放
      2. 每个页最多允许存放 `16KB / 2 - 200`行记录， 即7992行

3. InnoDB 行记录格式

4. 